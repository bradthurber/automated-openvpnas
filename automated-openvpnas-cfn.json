{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "CloudFormation template to automate OpenVPN AS deployment. (ami info can be found here: https://aws.amazon.com/marketplace/pp/B00MI40CAE)",
  
  "Metadata" : {
      "AWS::CloudFormation::Interface" : {
        "ParameterGroups" : [
          {
            "Label" : { "default" : "Network Configuration" },
            "Parameters" : [ "OpenVPNVPCId", "OpenVPNInstanceSubnet" ]
          },
          {
            "Label" : { "default":"EC2 Instance" },
            "Parameters" : [ "OpenVPNInstanceType", "OpenVPNLicenseType", "KeyPairName" ]
          },
          {
            "Label" : { "default":"Security" },
            "Parameters" : [ "OpenVPNAdminAccessIP", "OpenVPNAdminUserName", "OpenVPNAdminUserPassword", "UserUse" ]
          }
        ],
        "ParameterLabels" : {
          "OpenVPNVPCId" : { "default" : "VPCId" },
          "OpenVPNInstanceSubnet" : { "default" : "InstanceSubnet" }
            }
        }
    },

    "Parameters" : {
    
        "KeyPairName" : {
          "Description" : "Name of an existing EC2 KeyPair (find or create here: https://console.aws.amazon.com/ec2/v2/home#KeyPairs: )",
          "Type": "AWS::EC2::KeyPair::KeyName",
          "Default" : "yourkeypair",
          "ConstraintDescription" : "Must be a valid EC2 KeyPair"
        },

        "OpenVPNVPCId": {
          "Description" : "The VPC you wish to create the OpenVPN server in",
          "Type": "AWS::EC2::VPC::Id",
          "ConstraintDescription" : "Must be a valid VPC"  
        },

        "OpenVPNInstanceSubnet": {
          "Description" : "The subnet you wish to create the OpenVPN server in - this must be a public subnet",
          "Type": "AWS::EC2::Subnet::Id",
          "ConstraintDescription" : "Must be a valid Subnet"  
        },

        "UserUse" : {
          "Description" : "Will you need user access to OpenVPN? Setting to Yes will apply a user access security group to the instance",
          "Default" : "YES",
          "Type" : "String",
          "AllowedValues" : ["YES", "NO"],
          "ConstraintDescription" : "You must specify YES or NO."
        },

        "OpenVPNAdminAccessIP" : {
          "Description" : "Internet accessible IP address allowed to LOGIN and/or CONNECT to the OpenVPN AS appliance. (If you don't know it you can find here: www.ipchicken.com)",
          "Type" : "String",
          "MinLength": "9",
          "MaxLength": "18",
          "Default" : "0.0.0.0/32",
          "AllowedPattern" : "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/32",
          "ConstraintDescription" : "Must be a valid CIDR range of the form x.x.x.x/32"
        },

        "OpenVPNInstanceType" : {
          "Description" : "Choose an instance type. To keep free-tier pricing use default of t2.micro.",
          "Type" : "String",
          "Default" : "t2.micro",
          "AllowedValues" : [ "t2.micro", "t2.small", "t2.medium", "t2.large", "m4.large", "m4.xlarge", "m4.2xlarge", "m4.4xlarge", "m4.10xlarge", "m3.medium", "m3.large", "m3.xlarge"]
        },

        "OpenVPNLicenseType" : {
          "Description" : "Choose a license type (# Connected Devices). All include 2 free connections",
          "Type" : "String",
          "Default" : "BYOL",
          "AllowedValues" : [ "BYOL", "10", "25"]
        },

        "OpenVPNAdminUserName" : {
          "Description" : "Choose a non-default admin name for your OpenVPN AS instance.",
          "Type" : "String",
          "Default" : "youradminname",
          "AllowedPattern" : "([A-Za-z0-9-]{1,20})",
          "ConstraintDescription" : "Name must only contain alphanumeric characters and up to 20 characters long."
        },

        "OpenVPNAdminUserPassword" : {
          "Description" : "Enter a strong password (8 ~ 20 alphanumeric, special characters @ * # allowed) for your OpenVPN AS admin user.",
          "NoEcho" : "true",
          "Type" : "String",
          "Default" : "Ck6#*3a9",
          "AllowedPattern" : "([a-zA-Z0-9@*#]{8,20})",
          "ConstraintDescription" : "Password must be at least 8 characters but no longer than 20. You can use all alphanumeric characters and the special symbols @ * #"
        }

    },

    "Conditions" : {
          "CreateUserSG" : {"Fn::Equals" : [{"Ref" : "UserUse"}, "YES"]}
    },

    "Mappings" : {
        "OpenVPNRegionMap" : {
            "us-east-1" : { 
                "BYOL"  :   "ami-44aaf953", 
                "10"    :   "ami-b4affca3", 
                "25"    :   "ami-65a9fa72" },
            "us-west-1"     : { 
                "BYOL"  :   "ami-fa105b9a", 
                "10"    :   "ami-42165d22", 
                "25"    :   "ami-57175c37" },
            "us-west-2" : { 
                "BYOL"  :   "ami-e8d67288", 
                "10"    :   "ami-a6d773c6",
                "25"    :   "ami-a3d175c3" }
          }
    },

    "Resources" : {

          "openvpnadmin": {
              "Type" : "AWS::EC2::SecurityGroup",
              "Properties" : {
                  "GroupDescription" : "OpenVPN Administrator Access.",
                  "VpcId" : {"Ref" : "OpenVPNVPCId"},
                  "SecurityGroupIngress" : [{
                      "IpProtocol" : "tcp",
                      "FromPort" : "22",
                      "ToPort" : "22",
                      "CidrIp" : {"Ref": "OpenVPNAdminAccessIP"}
                  },{
                      "IpProtocol" : "tcp",
                      "FromPort" : "443",
                      "ToPort" : "443",
                      "CidrIp" : {"Ref": "OpenVPNAdminAccessIP"}
                  },{
                      "IpProtocol" : "udp",
                      "FromPort" : "1194",
                      "ToPort" : "1194",
                      "CidrIp" : {"Ref": "OpenVPNAdminAccessIP"}
                  }],
                  "Tags" :  [{"Key": "Name", "Value": "Admin-Access-OpenVPN-AS"}]
              }
          },

          "openvpnuser": {
              "Type" : "AWS::EC2::SecurityGroup",
              "Condition" : "CreateUserSG",
              "Properties" : {
                  "GroupDescription" : "OpenVPN User access.",
                  "VpcId" : {"Ref" : "OpenVPNVPCId"},
                  "SecurityGroupIngress" : [{
                      "IpProtocol" : "udp",
                      "FromPort" : "1194",
                      "ToPort" : "1194",
                      "CidrIp" : "0.0.0.0/0"
                  },{
                      "IpProtocol" : "tcp",
                      "FromPort" : "443",
                      "ToPort" : "443",
                      "CidrIp" : "0.0.0.0/0"
                  }],
                  "Tags" :  [{"Key": "Name", "Value": "User-Access-OpenVPN-AS"}]
              }
          },

          "OpenVPNEIP" : {
               "DependsOn" : ["OpenVPNInstance"],
               "Type" : "AWS::EC2::EIP",
               "Properties" : {
                   "InstanceId" : { "Ref" : "OpenVPNInstance" }
               }
          },

          "OpenVPNInstance" : {
                "DependsOn" : ["OpenVPNProfile","openvpnadmin"],
                "Type" : "AWS::EC2::Instance",
                "Properties" : {
                    "InstanceType" : {"Ref": "OpenVPNInstanceType"},
                    "IamInstanceProfile" : { "Ref" : "OpenVPNProfile" },
                    "SubnetId": { "Ref" : "OpenVPNInstanceSubnet" },
                    "KeyName" : { "Ref" : "KeyPairName" },
                    "SourceDestCheck" : "false",
                    "ImageId" : { "Fn::FindInMap" : [ "OpenVPNRegionMap", { "Ref" : "AWS::Region" }, { "Ref" : "OpenVPNLicenseType" } ]},
                    "SecurityGroupIds" : [{ "Ref" : "openvpnadmin" },{"Fn::If" : ["CreateUserSG", {"Ref" : "openvpnuser"},{ "Ref" : "openvpnadmin" }]}],
                    "Tags" : [{ "Key" : "Name", "Value" : "openvpn" }],
                    "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
                        "#!/bin/bash\n",
                        "apt-get update -y && apt-get upgrade -y\n",
                        "apt-get install python-pip -y && pip install awscli\n",
                        "admin_user=", { "Ref" : "OpenVPNAdminUserName" }, "\n",
                        "admin_pw=", { "Ref" : "OpenVPNAdminUserPassword" }, "\n",
                        "reroute_gw=1\n",
                        "reroute_dns=1\n",
                        "/usr/local/openvpn_as/scripts/sacli --key vpn.client.tls_version_min --value 1.2 ConfigPut\n",
                        "/usr/local/openvpn_as/scripts/sacli --key vpn.client.tls_version_min_strict --value true ConfigPut\n",
                        "/usr/local/openvpn_as/scripts/sacli --key vpn.server.tls_version_min --value 1.2 ConfigPut\n",
                        "/usr/local/openvpn_as/scripts/sacli --key vpn.server.google_auth.enable --value true ConfigPut\n",
                        "/usr/local/openvpn_as/scripts/sacli start\n"
					]]}}
                }

          },

          "OpenVPNRole": {
                 "Type": "AWS::IAM::Role",
                 "Properties": {
                    "AssumeRolePolicyDocument": {
                       "Statement": [ {
                          "Effect": "Allow",
                          "Principal": {
                             "Service": [ "ec2.amazonaws.com" ]
                          },
                          "Action": [ "sts:AssumeRole" ]
                       } ]
                    },
                    "Path": "/"
                 }
          },

          "OpenVPNProfile" : {
                  "DependsOn" : ["OpenVPNRole"],
                  "Type" : "AWS::IAM::InstanceProfile",
                  "Properties" : {
                    "Path" : "/",
                    "Roles" : [ { "Ref": "OpenVPNRole" } ]
                  }
          },

          "AppServerRolePolicies": {
                 "DependsOn" : ["OpenVPNRole","OpenVPNBucket"],
                 "Type": "AWS::IAM::Policy",
                 "Properties": {
                    "PolicyName": "OpenVPNS3Access",
                    "PolicyDocument": {
                       "Statement": [ {
                          "Effect": "Allow",
                          "Action": "s3:*",
                          "Resource": { "Fn::Join" : ["", [ "arn:aws:s3:::", { "Ref" : "OpenVPNBucket" } , "/*" ]] 
                          }
                       } ]
                    },
                    "Roles": [ { "Ref": "OpenVPNRole" } ]
                 }
          },

          "OpenVPNBucket" : {
                  "Type" : "AWS::S3::Bucket"
          }

    },

    "Outputs" : {

          "ASIPAddress" : {
                "Description" : "Your OpenVPN Public IP address.",
                "Value" : { "Fn::GetAtt" : [ "OpenVPNInstance", "PublicIp" ] }
          },

          "BucketName" : {
                "Description" : "Your S3 Bucket to Download .ovpn files.",
                "Value" : { "Ref" : "OpenVPNBucket" }
       }
    }

}
